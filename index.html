<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>PhotoCompress — Modern Indonesia</title>

<!-- Tema warna baru (dark-soft), anti silau -->
<style>
:root{
  --bg1:#1d232a;
  --bg2:#252c34;
  --card:#2f3640;
  --card-light:#3a414c;
  --text:#f2f5f7;
  --text-dim:#b8c0c8;
  --accent:#1e90ff;
  --accent2:#0b7cf0;
  --radius:14px;
  --shadow:0 14px 32px rgba(0,0,0,0.35);
}

/* RESET */
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
  background:var(--bg1);
  color:var(--text);
  padding:18px;
}

/* HEADER */
.app{width:100%;max-width:980px;margin:auto}
.header{
  display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;
}
.header h1{
  font-size:28px;font-weight:700;color:var(--text);
}
.tag{color:var(--text-dim);font-size:14px}

/* CARD */
.card{
  background:var(--card);
  border-radius:var(--radius);
  padding:16px;
  box-shadow:var(--shadow);
  transition:transform .2s ease;
}
.card:hover{transform:translateY(-4px)}

/* DROPZONE */
.dropzone{
  border:2px dashed rgba(255,255,255,0.18);
  border-radius:var(--radius);
  padding:32px;
  text-align:center;
  background:var(--card-light);
  cursor:pointer;
}
.dropzone.drag{
  border-color:var(--accent);
  background:#344150;
}
.dropzone svg{color:var(--accent);}

/* TEXT */
.hint{
  color:var(--text-dim);
  font-size:14px;
  margin-top:6px;
}

/* INPUT */
input[type="number"], input[type="range"]{
  width:100%;
}

/* BUTTONS (lebih besar & nyaman di HP) */
.btn{
  padding:12px 18px;
  border:none;
  border-radius:10px;
  font-size:16px;
  font-weight:600;
  cursor:pointer;
  background:var(--card-light);
  color:var(--text);
}
.btn.primary{
  background:var(--accent);
  color:white;
}
.btn:disabled{
  opacity:.5;
}

/* GRID */
.grid{
  display:grid;
  grid-template-columns:380px 1fr;
  gap:20px;
}
@media(max-width:900px){
  .grid{grid-template-columns:1fr}
}

/* GALLERY */
.gallery{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
  gap:14px;
}
.thumb{
  background:var(--card-light);
  border-radius:10px;
  overflow:hidden;
  box-shadow:var(--shadow);
}
.thumb img{
  width:100%;
  height:150px;
  object-fit:cover;
}

/* PROGRESS BAR */
#progressBar{
  width:0%;
  height:6px;
  background:var(--accent);
  border-radius:6px;
  transition:width .25s;
}
.progress-container{
  width:100%;
  background:#111;
  height:6px;
  border-radius:6px;
  margin:6px 0 12px 0;
}

/* PRIVACY POPUP */
#privacyModal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.75);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.privacy-box{
  background:var(--card);
  padding:20px;
  border-radius:12px;
  max-width:420px;
  width:90%;
  box-shadow:var(--shadow);
}
.privacy-box h2{
  margin-bottom:10px;
}
.close-privacy{
  margin-top:12px;
  width:100%;
}

/* CAMERA MODAL */
#camModal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.8);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.cam-box{
  background:var(--card);
  padding:14px;
  border-radius:12px;
  width:92%;
  max-width:400px;
}
.cam-video{
  width:100%;
  height:300px;
  background:#000;
  border-radius:10px;
  overflow:hidden;
}
.cam-video video{
  width:100%;height:100%;object-fit:cover;
}
</style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div>
        <h1>PhotoCompress</h1>
        <div class="tag">Kompres gambar di browser — privat & modern</div>
      </div>
      <div class="small">Bahasa: Indonesia</div>
    </div>

    <!-- global progress (file batch) -->
    <div class="progress-container card" style="margin-bottom:12px">
      <div id="progressBar"></div>
    </div>

    <div class="grid">
      <!-- LEFT: controls -->
      <div>
        <div class="card" id="panel">
          <div id="dropzone" class="dropzone" tabindex="0" aria-label="Tarik gambar ke sini atau pilih file">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" aria-hidden>
              <path d="M12 3v12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path>
              <path d="M8 7l4-4 4 4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path>
              <path d="M21 15v2a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-2" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>

            <div style="font-weight:700;margin-top:8px">Seret & jatuhkan gambar di sini</div>
            <div class="hint">atau <label for="fileInput" class="link">pilih file</label> • Maks 20 file</div>
          </div>

          <!-- hidden inputs -->
          <input id="fileInput" type="file" accept="image/*" multiple hidden>
          <input id="cameraInput" type="file" accept="image/*" capture="environment" hidden>

          <!-- controls -->
          <div class="controls" style="margin-top:12px">
            <div class="row">
              <div class="label">Kualitas</div>
              <input id="quality" type="range" min="10" max="95" value="82" class="range">
              <div id="qualityVal" style="min-width:36px;text-align:center;color:var(--text-dim);font-weight:700">82</div>
            </div>

            <div class="row">
              <div class="label">Lebar maks (px)</div>
              <input id="maxWidth" type="number" min="64" max="6000" value="2048" style="width:120px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text)">
              <div class="small" style="color:var(--text-dim)">Aspek rasio otomatis</div>
            </div>

            <div class="row" style="margin-top:10px;gap:8px">
              <button id="compressBtn" class="btn primary">Kompres</button>
              <button id="cameraBtn" class="btn">Ambil Foto</button>
              <button id="downloadZipBtn" class="btn" disabled>Unduh ZIP</button>
            </div>

            <div class="row" style="margin-top:8px">
              <button id="clearBtn" class="btn">Bersihkan</button>
              <button id="privacyBtn" class="btn">Kebijakan Privasi</button>
            </div>

            <div style="margin-top:10px" class="small">Status: <span id="status">0 file</span></div>
          </div>
        </div>
      </div>

      <!-- RIGHT: gallery / preview -->
      <div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <strong>Pratinjau</strong>
            <span class="small">Ketuk gambar untuk unduh</span>
          </div>

          <div id="gallery" class="gallery" aria-live="polite"></div>
        </div>
      </div>
    </div>

    <div style="height:10px"></div>
    <div class="small" style="text-align:center;color:var(--text-dim)">© PhotoCompress — semua proses di browser. Tidak ada upload.</div>
  </div>

  <!-- privacy modal (inline, single-file) -->
  <div id="privacyModal" role="dialog" aria-modal="true">
    <div class="privacy-box">
      <h2>Kebijakan Privasi — PhotoCompress</h2>
      <p>PhotoCompress melakukan semua kompresi secara lokal di perangkat Anda. Tidak ada gambar yang dikirim ke server kami. Kami tidak menyimpan data pribadi.</p>
      <p>Jika Anda menggunakan fitur kamera, izin kamera hanya digunakan untuk menangkap gambar dan tidak disimpan di server.</p>
      <button id="closePrivacy" class="btn close-privacy">Tutup</button>
    </div>
  </div>

  <!-- camera modal (for getUserMedia fallback) -->
  <div id="camModal" aria-hidden="true">
    <div class="cam-box">
      <div class="cam-video"><video id="camVideo" autoplay playsinline></video></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="camCapture" class="btn primary">Tangkap</button>
        <button id="camCancel" class="btn">Batal</button>
      </div>
    </div>
  </div>
  <!-- JSZip CDN -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.0/dist/jszip.min.js"></script>

<script>
/* ==========================
   ELEMENT SELECTION
========================== */
const fileInput = document.getElementById('fileInput');
const cameraInput = document.getElementById('cameraInput');
const cameraBtn = document.getElementById('cameraBtn');
const compressBtn = document.getElementById('compressBtn');
const downloadZipBtn = document.getElementById('downloadZipBtn');
const clearBtn = document.getElementById('clearBtn');
const privacyBtn = document.getElementById('privacyBtn');
const dropzone = document.getElementById('dropzone');

const qualityInput = document.getElementById('quality');
const qualityVal = document.getElementById('qualityVal');
const maxWidthInput = document.getElementById('maxWidth');

const gallery = document.getElementById('gallery');
const statusEl = document.getElementById('status');
const progressBar = document.getElementById('progressBar');

const privacyModal = document.getElementById('privacyModal');
const closePrivacy = document.getElementById('closePrivacy');

const camModal = document.getElementById('camModal');
const camVideo = document.getElementById('camVideo');
const camCapture = document.getElementById('camCapture');
const camCancel = document.getElementById('camCancel');

let files = [];
let compressedFiles = [];
let camStream = null;

function setStatus(t){ statusEl.textContent = t; }

/* ==========================
   QUALITY SLIDER
========================== */
qualityInput.addEventListener('input', ()=>{
  qualityVal.textContent = qualityInput.value;
});

/* ==========================
   DROPZONE
========================== */
dropzone.addEventListener('click', ()=> fileInput.click());

dropzone.addEventListener('dragover', e=>{
  e.preventDefault();
  dropzone.classList.add('drag');
});
dropzone.addEventListener('dragleave', ()=>{
  dropzone.classList.remove('drag');
});
dropzone.addEventListener('drop', e=>{
  e.preventDefault();
  dropzone.classList.remove('drag');
  handleFiles(e.dataTransfer.files);
});

/* ==========================
   FILE INPUT
========================== */
fileInput.addEventListener('change', e=>{
  if(e.target.files) handleFiles(e.target.files);
});

/* ==========================
   HANDLE FILES
========================== */
function handleFiles(list){
  const incoming = Array.from(list).filter(f=>f.type.startsWith('image/'));
  const allowed = incoming.slice(0, 20 - files.length);

  for(const f of allowed){
    files.push(f);
    previewThumb(f);
  }

  setStatus(files.length + " file siap");
}

/* ==========================
   PREVIEW THUMBNAIL
========================== */
function previewThumb(file){
  const wrap = document.createElement('div');
  wrap.className = "thumb";

  const img = document.createElement('img');
  img.alt = file.name;

  const meta = document.createElement('div');
  meta.className = "meta";
  meta.innerHTML = `
    <span>${file.name}</span>
    <span>${Math.round(file.size/1024)} KB</span>
  `;

  wrap.appendChild(img);
  wrap.appendChild(meta);
  gallery.prepend(wrap);

  const reader = new FileReader();
  reader.onload = ()=> img.src = reader.result;
  reader.readAsDataURL(file);

  img.addEventListener('click', ()=>{
    const a = document.createElement('a');
    a.href = img.src;
    a.download = file.name;
    a.click();
  });
}

/* ==========================
   BUTTON — BERSIHKAN
========================== */
clearBtn.addEventListener('click', ()=>{
  files = [];
  compressedFiles = [];
  gallery.innerHTML = "";
  progressBar.style.width = "0%";
  downloadZipBtn.disabled = true;
  setStatus("bersih");
});

/* ==========================
   COMPRESS ALL FILES
========================== */
compressBtn.addEventListener('click', async ()=>{
  if(files.length === 0){
    alert("Belum ada file untuk dikompres.");
    return;
  }

  compressBtn.disabled = true;
  setStatus("Mengompres...");
  compressedFiles = [];

  const total = files.length;

  for(let i=0;i<total;i++){
    const f = files[i];
    setStatus(`Mengompres ${i+1}/${total} ...`);

    const blob = await compressImage(f, {
      quality: Number(qualityInput.value)/100,
      maxWidth: Number(maxWidthInput.value),
    });

    const ext = supportsWebP() ? ".webp" : ".jpg";
    const newName = f.name.replace(/\.[^/.]+$/, "") + ext;

    compressedFiles.push({name:newName, blob});

    // update progress bar
    progressBar.style.width = Math.floor(((i+1)/total)*100) + "%";
  }

  downloadZipBtn.disabled = false;
  setStatus("Selesai — " + compressedFiles.length + " file");
  compressBtn.disabled = false;
});

/* ==========================
   ZIP DOWNLOAD
========================== */
downloadZipBtn.addEventListener('click', async ()=>{
  const zip = new JSZip();

  compressedFiles.forEach(f=>{
    zip.file(f.name, f.blob);
  });

  setStatus("Membuat ZIP...");

  const content = await zip.generateAsync({type:'blob'}, meta=>{
    progressBar.style.width = Math.floor(meta.percent)+"%";
  });

  const url = URL.createObjectURL(content);
  const a = document.createElement('a');
  a.href = url;
  a.download = "hasil_kompres.zip";
  a.click();

  URL.revokeObjectURL(url);

  setStatus("ZIP siap diunduh");
});

/* ==========================
   IMAGE COMPRESSOR
========================== */
async function compressImage(file, {quality, maxWidth}){
  const img = await loadImage(file);

  const {width, height} = resizePreserve(img.width, img.height, maxWidth);

  const canvas = document.createElement('canvas');
  canvas.width = width;
  canvas.height = height;

  const ctx = canvas.getContext('2d');
  ctx.imageSmoothingQuality = "high";
  ctx.drawImage(img, 0,0,width,height);

  const mime = supportsWebP() ? "image/webp" : "image/jpeg";

  return await new Promise(resolve=>{
    canvas.toBlob(b=>resolve(b), mime, quality);
  });
}

function loadImage(file){
  return new Promise((res,rej)=>{
    const reader = new FileReader();
    reader.onload = ()=>{
      const img = new Image();
      img.onload = ()=> res(img);
      img.onerror = rej;
      img.src = reader.result;
    };
    reader.onerror = rej;
    reader.readAsDataURL(file);
  });
}

function resizePreserve(w,h,maxW){
  if(w <= maxW) return {width:w, height:h};
  const ratio = maxW / w;
  return {width: Math.round(w*ratio), height: Math.round(h*ratio)};
}

function supportsWebP(){
  try{
    const c = document.createElement('canvas');
    return c.toDataURL("image/webp").indexOf("webp") !== -1;
  }catch(e){ return false; }
}

/* ==========================
   PRIVACY POPUP
========================== */
privacyBtn.addEventListener('click', ()=>{
  privacyModal.style.display = "flex";
});
closePrivacy.addEventListener('click', ()=>{
  privacyModal.style.display = "none";
});

/* ==========================
   CAMERA (native + fallback)
========================== */
cameraBtn.addEventListener('click', async ()=>{

  // coba native capture dulu
  cameraInput.click();

  const changed = await waitChange(cameraInput, 1200);
  if(changed) return;

  // fallback getUserMedia
  openCameraModal();
});

cameraInput.addEventListener('change', e=>{
  if(e.target.files && e.target.files.length){
    handleFiles(e.target.files);
  }
});

/* WAIT FOR INPUT CHANGE */
function waitChange(input, ms=1000){
  return new Promise(resolve=>{
    let changed = false;

    const handler = ()=>{
      changed = true;
      cleanup();
      resolve(true);
    };

    input.addEventListener('change', handler);
    const timeout = setTimeout(()=>{
      if(!changed){
        cleanup();
        resolve(false);
      }
    }, ms);

    function cleanup(){
      clearTimeout(timeout);
      input.removeEventListener('change', handler);
    }
  });
}

/* OPEN CAMERA MODAL */
async function openCameraModal(){
  camModal.style.display = "flex";

  try{
    camStream = await navigator.mediaDevices.getUserMedia({
      video:{facingMode:"environment"},
      audio:false
    });
    camVideo.srcObject = camStream;
  }catch(err){
    alert("Izin kamera ditolak atau tidak tersedia.");
    camModal.style.display = "none";
  }
}

camCancel.addEventListener('click', closeCamera);

function closeCamera(){
  if(camStream){
    camStream.getTracks().forEach(t=>t.stop());
    camStream = null;
  }
  camModal.style.display = "none";
}

/* CAPTURE BUTTON */
camCapture.addEventListener('click', ()=>{
  if(!camVideo.srcObject) return;

  const canvas = document.createElement('canvas');
  canvas.width = camVideo.videoWidth;
  canvas.height = camVideo.videoHeight;

  const ctx = canvas.getContext('2d');
  ctx.drawImage(camVideo, 0,0);

  canvas.toBlob(blob=>{
    const file = new File([blob], "camera_"+Date.now()+".jpg", {type:"image/jpeg"});
    handleFiles([file]);
    closeCamera();
  },"image/jpeg",0.92);
});

/* ==========================
   END
========================== */
setStatus("Siap");

</script>
</body>
</html>
